{% extends "debate/base.html" %}
{% load staticfiles %}
{% load humanize %}
{% load md2 %}
{% load comments %}
{% load comments_xtd %}
{% load widget_tweaks %}
{% load debate_filter %}

{% block extra_nav %}

      {% if user_is_moderator %}
        <li class="divider"></li>
        <li>
          <a href="{% url 'debate:edit_debate_post' post.id %}">
              Edit Debate</a></li>
        <li class="divider"></li>

        <li><a href="{% url 'debate:mod_debate' post.pk %}">
          Go to Mod</a></li>
      {% endif %}

      {% if user_is_judge %}
          <li class="divider"></li>
        <li><a href="{% url 'debate:score_debate' post.pk %}">
          Score Debate</a></li>
      {% endif %}

{% endblock extra_nav %}


<!-- Main Post details -->
{% block content %}

<div class="row">
  <div class="col m2 l2">
        {% if user_is_moderator %}
          <p>
            Moderator Panel
          <div class="panel-body">
              <a href="{% url 'debate:mod_debate' post.pk %}">
                <button type="button" class="btn btn-primary">Go to Mod</button></a>
              <hr/>
              <p>Approve debaters and edit debate start and end times.</p>
          </div>
        </p>
        {% endif %}


        {% if user_is_judge %}
            Judges Panel
          <div class="panel-body">
              <a href="{% url 'debate:score_debate' post.pk %}">
                <button type="button" class="btn btn-primary">Score Debate</button>
              </a><hr/>
              <p>Use panel to score debates if debate has ended.</p>
            </div>

          {% endif %}

    </div>


<div class="col m7 l7">
{% if post %}
<!-- Card Projects -->
    <div class="card">
      <div class="card-content">
        {% for tag in post.tags.all %}
          <a href="{% url 'debate:debate_list_by_tag' tag.slug  %}"><span class="new badge grey" data-badge-caption="">{{ tag.name }}</span></a>
        {% endfor %}
        {% if post.updated != post.created %}<p class="small">Edited</p>{% endif %}
        <h5 class="">{{post.title}}</h5>
        <p class="justify">{{post.summary|markdown:"safe, code-friendly, code-color"|linebreaks}}</p>
        {% if user_is_moderator %}
          <a href="{% url 'debate:edit_debate_post' post.id %}">
              <span class="small">Edit Debate</span></a>
        {% endif %}

        {% get_comment_count for post as comment_count %}
        <span class="right">
          <i class="material-icons">comment</i> {{ comment_count }}
        </span>

    <span class="right">
        {% if user.is_authenticated %}
          {% if liked %}
          <a class="btn btn-floating white">
            <i class="material-icons like-button blue-text" name="{{ post.slug }}" value="Like">thumb_up</i></a>
          {% else %}
          <a class="btn btn-floating white"><i class="material-icons like-button grey-text" name="{{ post.slug }}" value="Like">thumb_up</i></a>
          {% endif %}

        <span class="total_likes right">{{ post.total_likes }}</span>

      {% else %}
      <a class="btn btn-floating grey tooltipped" data-position="top" data-delay="50" data-tooltip="Login or Signup to like.">
        <i class="tiny material-icons ">thumb_up</i></a>
      <span>{{post.total_likes}}</span>
      {% endif %}
    </span>

          <div class="fixed-action-btn horizontal">
            <a class="btn-floating btn-large red pulse">
              <i class="large material-icons">share</i>
            </a>
            <ul>
              <li><a href="http://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}"
                 class="waves-effect waves-light btn-floating social facebook">
                      <i class="fa fa-facebook"></i></a></li>
              <li><a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri|urlencode }}"
                class="waves-effect waves-light btn-floating social twitter">
                      <i class="fa fa-twitter"></i></a></li>
              <li><a href="http://www.linkedin.com/shareArticle?url={{ request.build_absolute_uri|urlencode }}&title={{post.title}}&summary={{post.summary}}&source={{ request.get_host }}"
                class="waves-effect waves-light btn-floating social linkedin">
                      <i class="fa fa-linkedin"></i></a></li>
              {% if request.user_agent.is_mobile or request.user_agent.is_tablet %}
              <li><a href="whatsapp://send?text='{{request.get_host}}{{ post.get_absolute_url }}  \n {{post.title}}'" data-action="share/whatsapp/share" class="waves-effect waves-light btn-floating social whatsapp">
                      <i class="fa fa-whatsapp"></i></a></li>
              {% endif %}
            </ul>
          </div>
      </div>
      <div class="card-tabs">
        <ul class="tabs tabs-fixed-width">
          <li class="tab"><a class="active" href="#details">Details</a></li>
          <li class="tab"><a href="#debaters">Debaters</a></li>
          <li class="tab"><a href="#panel">Panel</a></li>
        </ul>
      </div>
      <div class="card-content grey lighten-4">
        <div id="details">
          <p>Category: {{post.debate_category | capfirst}} Debate <br>
          By <a href="{{post.author.profile.get_absolute_url}}">{{post.author.get_full_name}}</a></p>
          {% if post.winner_updated %}
          <p>Winning Team:
            <span class="pull-right"><i class="fa fa-glass fa-lg" aria-hidden="true">{{post.winner}}</i></span>
          </p>
          {% endif %}
          {% if post.begin %}<p>Began {{post.begin|naturaltime}}</p>{% else %}<p>Debate starts soon.</p>{% endif %}
          {% if post.end %} <p>Ends {{post.end|naturaltime}}</p>{% endif %}
          {% if debate_in_progress %}
          Status: Debate in progress
          {% endif %}
          {% if debate_has_ended %}
          Status: Debate had ended
          {% endif %}


        </div>

    <div id="debaters">
      <div class="row">
      {% if post.debate_category == "open" %}
        <p>Specific debaters are not included for open debates. Contribution from all are welcome.</p>
      {% else %}
        <div class="col m6">
        {% if post.supporting_debaters.all %}
          <h6>Supporting </h6><span><i class="material-icons">group</i></span>
          <ul class="collection">
            {% for names in post.supporting_debaters.all %}
            <li class="collection-item avatar">
              {% if names.profile.image %}
              <img src="{{ names.profile.image.thumbnail.50x50 }}" alt="" class="circle">
              {% else %}
              <img src="{{MEDIA_URL}}/__placeholder__/placeholder.png" width=50, height=50 class="circle"/>
              {% endif %}
              <span class="title">{{ names.get_full_name }}</span>
              <p><a href={{names.profile.get_absolute_url}}>@{{names.username}}</a> <br>
                 Speaker {{forloop.counter}}
              </p>
              <a href="#!" class="secondary-content"><i class="material-icons">grade</i></a>
            </li>
            {% endfor %}
            </ul>
        {%endif%}

        {% if user.is_authenticated and not debate_in_progress and post.debate_category == "closed"  %}
        <a href={% url 'debate:join_participants' post_id=post.id position="supporting"  %}>
          Apply to join supporting team.
        </a>
        {% endif %}
        </div>

        <div class="col m6">
        {% if post.opposing_debaters.all %}
          <h6>Opposing </h6><span><i class="material-icons">group</i></span>
          <ul class="collection">
            {% for names in post.opposing_debaters.all %}
            <li class="collection-item avatar">
              {% if names.profile.image %}
              <img src="{{ names.profile.image.thumbnail.50x50 }}" alt="" class="circle">
              {% else %}
              <img src="{{MEDIA_URL}}/__placeholder__/placeholder.png" width=50, height=50 class="circle"/>
              {% endif %}
              <span class="title">{{ names.get_full_name }}</span>
              <p><a href={{names.profile.get_absolute_url}}>@{{names.username}}</a> <br>
                 Speaker {{forloop.counter}}
              </p>
              <a href="#!" class="secondary-content"><i class="material-icons">grade</i></a>
            </li>
            {% endfor %}
            </ul>
          {%endif%}

        {% if user.is_authenticated and not debate_in_progress and post.debate_category == "closed"%}
        <a href={% url 'debate:join_participants' post_id=post.id position="opposing"  %}>
          Apply to join opposing team.
        </a>
        {% endif %}
        </div>
      {% endif %}
      </div><!-- End of row div -->
    </div><!-- End of debaters div -->

        <div id="panel">
          <div class="row">
            <div class="col m6">
            {% if post.moderator.all %}
              <h6>Moderator(s) </h6><span><i class="material-icons">group</i></span>
              <ul class="collection">
                {% for names in post.moderator.all %}
                <li class="collection-item avatar">
                  {% if names.profile.image %}
                  <img src="{{ names.profile.image.thumbnail.50x50 }}" alt="" class="circle">
                  {% else %}
                  <img src="{{MEDIA_URL}}/__placeholder__/placeholder.png" width=50, height=50 class="circle"/>
                  {% endif %}
                  <span class="title">{{ names.get_full_name }}</span>
                  <p><a href={{names.profile.get_absolute_url}}>@{{names.username}}</a> <br>
                     Mod {{forloop.counter}}
                  </p>
                  <a href="#!" class="secondary-content"><i class="material-icons">grade</i></a>
                </li>
                {% endfor %}
              </ul>
            {%endif%}
          </div>
          <div class="col m6">
              {% if post.judges.all %}
                <h6>Judge(s) </h6><span><i class="material-icons">group</i></span>
                <ul class="collection">
                  {% for names in post.judges.all %}
                  <li class="collection-item avatar">
                    {% if names.profile.image %}
                    <img src="{{ names.profile.image.thumbnail.50x50 }}" alt="" class="circle">
                    {% else %}
                    <img src="{{MEDIA_URL}}/__placeholder__/placeholder.png" width=50, height=50 class="circle"/>
                    {% endif %}
                    <span class="title">{{ names.get_full_name }}</span>
                    <p><a href={{names.profile.get_absolute_url}}>@{{names.username}}</a> <br>
                       Judge {{forloop.counter}}
                    </p>
                    <a href="#!" class="secondary-content"><i class="material-icons">grade</i></a>
                  </li>
                  {% endfor %}
                </ul>
              {%endif%}

            </div>

          </div><!-- End of row div -->


        </div>
      </div>


      {%if attachments%}
      <div class="row">
        <div class="card-image">
      {%for image in attachments%}
        {% if attachments.count == 1 %}
            <div class="row">
              <div class="col m3"></div>
              <div class="col m6">
                <span id="image{{forloop.counter}}" post_id ={{post.id}} image_id = {{image.id}} >
                  <i class="fa fa-spinner fa-spin fa-3x fa-fw"></i>
                    <span class="sr-only">Loading...</span>
                </span>
              </div>
            </div>

        {% else %}

          <div class="col l6 ">
          <p id="image{{forloop.counter}}" post_id ={{post.id}} image_id = {{image.id}} >
            <i class="fa fa-spinner fa-spin fa-3x fa-fw"></i>
              <span class="sr-only">Loading...</span>
          </p>
          </div>


        {% endif %}
        {% endfor %}
        </div>
        </div>
      {% endif %}


    </div> <!-- End of card -->
{% endif %}
      <p>Confused? Read our <a href="">FAQs</a> and <a href="{% url 'debate:rules_guidelines' %}">Rules</a> to understand how things work here</p>
      {% get_comment_form for post as form %}
      {% if post.debate_category == "open" or user_is_moderator %}
    <div class="card">
      <div class="row">
        <form class="col s12" method="POST" action="{% comment_form_target %}">
          {% csrf_token %}
          <div class="row">
            {% if post.debate_category == "open" %}
            <div class="input-field col s12 m4 right">
              <select name="debate_option" id = "debate_option">
                <option value="" disabled selected>Choose a side</option>
                <option value="I agree">agree</option>
                <option value="I disagree">disagree</option>
              </select>
              <label>Debate Position</label>
            </div>
            {% endif %}
          </div>

              <input type="hidden" name="next" value="{% url 'comments-xtd-sent' %}"/>
              <div class="red-text hidden" data-comment-element="errors"></div>
              {% for field in form %}
                {% if field.is_hidden %}<div>{{ field }}</div>{% endif %}
              {% endfor %}
              <div style="display:none">{{ form.honeypot }}</div>

          <div class="row">
            <div class="input-field col s12 {% if 'comment' in form.errors %}has-error{% endif %}">
              {% render_field form.comment class="materialize-textarea" data-length="3000" %}
              <label for="id_comment">Enter your comment</label>
            </div>
          </div>

          <div>
              <input type="submit" name="post" value='send' class="btn" />
              <input type="submit" name="preview" value="preview" class="btn grey" />
          </div>

          <div class="row">
          <p class="small">
            <a href='http://commonmark.org/help/' target='_blank'>Mardown </a>and <a target='_blank' href="https://math.meta.stackexchange.com/questions/5020/mathjax-basic-tutorial-and-quick-reference">MathJax</a> supported.
            <br>For open debate, indicate if supporting or opposing at top of comment.
          </p>
        </div>

        </form>
      </div>
    </div>
      {% endif %}


      {% if user_in_opposing_team or user_in_supporting_team or user_is_judge and debate_in_progress %}
      <div class="card">
        <div class="row">
          <form class="col s12" method="POST" action="{% comment_form_target %}">
            {% csrf_token %}
            <div class="row">
              {% if post.debate_category == "open" %}
              <div class="input-field col s12 m4 right">
                <select name="debate_option" id = "debate_option">
                  <option value="" disabled selected>Choose a side</option>
                  <option value="I agree">agree</option>
                  <option value="I disagree">disagree</option>
                </select>
                <label>Debate Position</label>
              </div>
              {% endif %}
            </div>

                <input type="hidden" name="next" value="{% url 'comments-xtd-sent' %}"/>
                <div class="red hidden" data-comment-element="errors"></div>
                {% for field in form %}
                  {% if field.is_hidden %}<div>{{ field }}</div>{% endif %}
                {% endfor %}
                <div style="display:none">{{ form.honeypot }}</div>

            <div class="row">
              <div class="input-field col s12 {% if 'comment' in form.errors %}has-error{% endif %}">
                <label for="id_comment">Enter your comment</label>
                {% render_field form.comment class="materialize-textarea" placeholder="Be concise and cogent." %}
              </div>
            </div>

            <div>
                <input type="submit" name="post" value='send' class="btn" />
                <input type="submit" name="preview" value="preview" class="btn grey" />
            </div>

            <div class="row">
            <p class="small">
              <a href='http://commonmark.org/help/' target='_blank'>Mardown </a>and <a target='_blank' href="https://math.meta.stackexchange.com/questions/5020/mathjax-basic-tutorial-and-quick-reference">MathJax</a> supported in comments.
              <br>For open debate, indicate if supporting or opposing at top of comment.
            </p>
          </div>

          </form>
        </div>
      </div>
      {% endif %}

      {% if user.is_authenticated and debate_has_ended and not user_is_judge and not user_is_moderator and not user_in_opposing_team and not user_in_supporting_team %}
      <div class="card">
        <div class="row">
          <form class="col s12" method="POST" action="{% comment_form_target %}">
            {% csrf_token %}
            <div class="row">
              {% if post.debate_category == "open" %}
              <div class="input-field col s12 m4 right">
                <select name="debate_option" id = "debate_option">
                  <option value="" disabled selected>Choose a side</option>
                  <option value="I agree">agree</option>
                  <option value="I disagree">disagree</option>
                </select>
                <label>Debate Position</label>
              </div>
              {% endif %}
            </div>

                <input type="hidden" name="next" value="{% url 'comments-xtd-sent' %}"/>
                <div class="red hidden" data-comment-element="errors"></div>
                {% for field in form %}
                  {% if field.is_hidden %}<div>{{ field }}</div>{% endif %}
                {% endfor %}
                <div style="display:none">{{ form.honeypot }}</div>

            <div class="row">
              <div class="input-field col s12 {% if 'comment' in form.errors %}has-error{% endif %}">
                <label for="id_comment">Enter your comment</label>
                {% render_field form.comment class="materialize-textarea" placeholder="Be concise and cogent." %}
              </div>
            </div>

            <div>
                <input type="submit" name="post" value='send' class="btn " />
                <input type="submit" name="preview" value="preview" class="btn grey" />
            </div>

            <div class="row">
            <p class="small">
              <a href='http://commonmark.org/help/' target='_blank'>Mardown </a>and <a target='_blank' href="https://math.meta.stackexchange.com/questions/5020/mathjax-basic-tutorial-and-quick-reference">MathJax</a> supported in comments.
              <br>For open debate, indicate if supporting or opposing at top of comment.
            </p>
          </div>

          </form>
        </div>
      </div>
      {% endif %}

      {% if comment_count %}
            {% render_xtdcomment_tree for post allow_flagging allow_feedback show_feedback  %}
    {% endif %}

{% if not post %}
  <p>There are currently no debates posted. You can add a debate or check back</p>
{% endif %}
</div>

  <div class="col m3 l3">
    <p>
      <a href="{% url 'debate:suggest_post' %}">
    <button class="btn">Create a new debate</button></a>
    </p>

    <div class="card">
      <div class="card-content">
        <div class="row">
        {% if voted_before or not post.begin or debate_in_progress or not user.is_authenticated %}
        <div class="col s12 m6">
          <a name="{{ post.slug }}" value="support" class="waves-effect waves-light vote btn-floating disabled">
            <i class="material-icons">thumbs_up_down</i></a>
            Support
        </div>
        <div class="col s12 m6">
          <a name="{{ post.slug }}" value="oppose" class="waves-effect waves-light vote btn-floating disabled">
            <i class="material-icons">thumbs_up_down</i></a>
            Oppose
        </div>
        {% else %}
        <div class="col s12 m6">
          <a name="{{ post.slug }}" value="support" class="waves-effect waves-light vote btn-floating">
            <i class="material-icons">thumbs_up_down</i></a>
            Support
        </div>
        <div class="col s12 m6">
          <a name="{{ post.slug }}" value="oppose" class="waves-effect waves-light vote btn-floating">
            <i class="material-icons">thumbs_up_down</i></a>
            Oppose
        </div>

        {% endif %}
      </div>


        <p class="debate_stand small"><br>
        {% if vote_message %}{{vote_message}}
        {% else %}You have not voted in this debate{% endif %}
        <br>
          {% if not user.is_authenticated %}
          <a href="{% url 'account_login' %}">Login</a> or <a href="{% url 'account_signup' %}">SignUp</a> to vote.
          {% endif %}
        </p><hr/>
        <p class="small">Voting Starts :
            {% if post.vote_starts %}{{post.vote_starts}}{% else %}Not yet set by Mod{%endif%}<br>
          Voting Ends :
            {% if post.end %}{{post.end}}{% else %}Not yet set by Mod{%endif%}<br>
          Result displayed afterwards. Please be patient.</p>
      </div>
    </div>


      {% if debate_has_ended %}

        <p aria-label="Debate Results" class="text-danger">Results:<br>
        Supporting Team: {{total_support_vote}} votes<br>
        Opposing Team: {{total_oppose_vote}} votes
        </p>

      {% endif %}


    {% if post.count %}
        <div class="card">
          <div class="card-content">
        Total Followers : <br>{{post.count}}
          </div>
        </div>
    {% endif %}

    <div class="card">
      <div class="card-content">
          <i class="small material-icons">access_alarm</i>
          {% if notify_status or not user.is_authenticated %}
            <button  name="{{ post.slug }}" value="notify" class="btn disabled notify">Notify Me</button>
          {% else %}
            <button  name="{{ post.slug }}" value="notify" class="btn notify">Notify Me</button>
          {% endif %}
          <hr>
          {% if notify_status %}
            <p class="has_set_notification small">You have previously set notification for this debate. You would be notified via email 15 mins before debate starts.</p><br>
          {% else %}
            <p class="has_set_notification small">Enable alert for debate to get notified before debate starts. {%if not user.is_authenticated %}You must be <a href="{% url 'account_login' %}">logged in</a>.{%endif%}</p><br>
          {% endif %}
      </div>
    </div>

 </div>

 </div>


{% endblock %}

{% block extra-js %}
<script>

$(document).ready(function(){
    $("select#debate_option").change(function(){
        var text_content =$("textarea#id_comment").val();
        var debate_option = $("#debate_option option:selected").val();
        $("textarea#id_comment").val("`"+debate_option + "`\n" + text_content);
    });
});

</script>
<script>
$('.like-button').click(function(){
      $.ajax({
               type: "POST",
               url: "{% url 'debate:like' %}",
               data: {'slug': $(this).attr('name'), 'csrfmiddlewaretoken': '{{ csrf_token }}'},
               dataType: "json",
               success: function(response) {
                      // alert(response.message);
                      // alert('Debate likes count is now ' + response.likes_count);
                      $(".total_likes").text(response.likes_count);
                      if (response.liked){
                        if($(".like-button").hasClass("grey-text")){
                             $(".like-button").removeClass("grey-text").addClass("blue-text");
                           };
                      }else{
                        $(".like-button").removeClass("blue-text").addClass("grey-text");
                      };
                },
                error: function(rs, e) {
                       //alert(rs.responseText);
                }

          });


});

$('.vote').click(function(){
      $.ajax({
               type: "POST",
               url: "{% url 'debate:vote' %}",
               data: {'slug': $(this).attr('name'), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'debate_stand':$(this).attr('value')},
               dataType: "json",
               success: function(response) {
                      //alert(response.message);
                      $(".debate_stand").text(response.message);
                      $(".vote").addClass("disabled");

                },
                error: function(rs, e) {
                       //alert(rs.responseText);
                }
          });
});

$('.notify').click(function(){
      $.ajax({
               type: "POST",
               url: "{% url 'debate:notify' %}",
               data: {'slug': $(this).attr('name'), 'csrfmiddlewaretoken': '{{ csrf_token }}', },
               dataType: "json",
               success: function(response) {
                      //alert(response.message);
                      $(".has_set_notification").text(response.message);
                      $(".notify").addClass("disabled");

                },
                error: function(rs, e) {
                       //alert(rs.responseText);
                }
          });
});


{% for image in attachments %}

$(document).ready(function(){
  var id = {{forloop.counter}}
  var img_css_id = "image"+id.toString()
  //console.log(img_css_id)
  $.ajax({
           type: "POST",
           url: "{% url 'debate:load_image' %}",
           data: {'csrfmiddlewaretoken': '{{ csrf_token }}', 'post_id':$("#"+img_css_id).attr('post_id'),'image_id':$("#"+img_css_id).attr('image_id'), },
           success: function(response) {
                  $('#'+img_css_id).html('<img class="responsive-img", src="data:image/png;base64,' + response + '" />');

            },
            error: function(rs, e) {
                   //alert(rs.responseText);
            }
      });
});

{% endfor %}

</script>
{% endblock %}
