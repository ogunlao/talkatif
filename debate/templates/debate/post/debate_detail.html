{% extends "debate/base.html" %}
{% load staticfiles %}
{% load humanize %}
{% load md2 %}
{% load markdownify %}
{% load comments %}
{% load comments_xtd %}
{% load widget_tweaks %}
{% load debate_filter %}
{% load avatar_tags %}

{% block title %}debate - {{post.title}}{% endblock title %}
{% block extra_nav %}

      {% if user_is_moderator %}
        <li class="divider"></li>
        <li>
          <a href="{% url 'debate:edit_debate_post' post.id %}">
              Edit Debate</a></li>
        <li class="divider"></li>

        <li><a href="{% url 'debate:mod_debate' post.pk %}">
          Go to Mod<i class="material-icons">remove_red_eye</i></a></li>
      {% endif %}

      {% if user_is_judge %}
          <li class="divider"></li>
        <li><a href="{% url 'debate:score_debate' post.pk %}">
          Score Debate<i class="material-icons">playlist_add_check</i></a></li>
      {% endif %}

{% endblock extra_nav %}


<!-- Main Post details -->
{% block content %}

<div class="row">
  <div class="col m2 l2">
    <div class="hide-on-small-only">
        {% if user_is_moderator %}

          <div class="card-panel">
                <h6>Moderator Panel</h6>
                  <a class="blue btn tooltipped" href="{% url 'debate:mod_debate' post.pk %}"
                      data-position="top" data-delay="50" data-tooltip="Approve debaters and edit debate start and end times.">Goto Mod</a>
                </div>

        {% endif %}


        {% if user_is_judge %}

          <div class="card-panel">
              <h5>Judges Panel</h5>
              <a class="blue btn" href="{% url 'debate:score_debate' post.pk %}"
              data-position="top" data-delay="50" data-tooltip="Input debate score when it ends.">Score Debate</a>
            </div>

          {% endif %}
      </div>
    </div>


<div class="col m7 l7">

{% if post %}

<!-- Card Projects -->
    <div class="card">
      <div class="card-content">
        {% for tag in post.tags.all %}
          <a href="{% url 'debate:debate_list_by_tag' tag.slug  %}"><span class="new badge amber lighten-4 black-text" data-badge-caption="">{{ tag.name }}</span></a>
        {% endfor %}
        {% if post.updated != post.created %}<small class="grey-text">Last Edited {{post.updated|naturaltime}}</small>{% endif %}
        <h5 class="blue-text main_title">{{post.title}}</h5>
        <p class="justify">{{post.summary|markdown:"safe, code-friendly, code-color"}}</p>
        {% if user_is_moderator %}
          <a href="{% url 'debate:edit_debate_post' post.id %}">
              <span class="small_text">Edit Debate</span></a>
        {% endif %}

        {% get_comment_count for post as comment_count %}
        <span class="right">
          <i class="material-icons">comment</i> {{ comment_count }}
        </span>

    <span class="right">
        {% if user.is_authenticated %}

          <a class="btn btn-floating waves-effect white">
            <i class="tiny material-icons like-button {% if liked %} blue-text {% else %}grey-text {% endif %} " name="{{ post.slug }}" value="Like">thumb_up</i></a>

        <span class="total_likes right">{{ post.total_likes }}</span>

      {% else %}
      <a class="btn btn-floating grey tooltipped" data-position="top" data-delay="50" data-tooltip="Login or Signup to like.">
        <i class="tiny material-icons">thumb_up</i></a>
      <span>{{post.total_likes}}</span>
      {% endif %}
    </span>

        {% include "share_button.html" %}
      </div>
      <div class="card-tabs">
        <ul class="tabs tabs-fixed-width">
          <li class="tab"><a class="blue-text active" href="#details">Details</a></li>
          <li class="tab"><a class="blue-text" href="#debaters">Debaters</a></li>
          <li class="tab"><a class="blue-text" href="#panel">Panel</a></li>
        </ul>
      </div>
      <div class="card-content grey lighten-4">
        <div id="details">
          <p>Category: {{post.debate_category | capfirst}} Debate <br>
          By <a href="{{post.author.profile.get_absolute_url}}">{{post.author.get_full_name}}</a></p>
          {% if post.winner_updated %}
          <p>Winning Team:
            <span><i class="fa fa-glass fa-lg" aria-hidden="true">{{post.winner|capfirst}}</i></span>
          </p>
          {% endif %}
          {% if post.begin %}<p>Starting time:  {{post.begin|naturaltime}}</p>{% else %}<p>Debate starts soon.</p>{% endif %}
          {% if post.end %} <p>Ending time: {{post.end|naturaltime}}</p>{% endif %}

          {% if debate_in_progress %}
          Status: Debate in progress
          {% endif %}
          {% if debate_has_ended %}
          Status: Debate had ended
          {% endif %}<br>
          Comment Settings: {% if post.allow_follower_comment %} Comments opened after close of debate {% else %}
          Debate is closed to all form of comments {% endif %}

        </div>

    <div id="debaters">
      <div class="row">
      {% if post.debate_category == "open" %}
        <p>Specific debaters are not included for open debates. Contribution from all are welcome.</p>
      {% else %}
        <div class="col m6">
        {% if post.supporting_debaters.all %}
          <h6>Supporting </h6><span><i class="material-icons">group</i></span>
          <ul class="collection">
            {% for names in post.supporting_debaters.all %}
            <li class="collection-item avatar">
              {% if names|has_avatar %}
                {% avatar names 35 class="circle responsive-img" %}
              {% elif names.socialaccount_set.all.0.get_avatar_url %}
                <img  src="{{ names.socialaccount_set.all.0.get_avatar_url }}" class="circle responsive-img" width="35" height="35" />
              {% else %}
                <img src="{{names.profile.profile_image_url}}" class="circle responsive-img" width="35" height="35" />
              {% endif %}
              <span class="title">{{ names.get_full_name }}</span>
              <p><a href={{names.profile.get_absolute_url}}>@{{names.username}}</a> <br>
                 Speaker {{forloop.counter}}
              </p>

            </li>
            {% endfor %}
            </ul>
        {%endif%}

        {% if user.is_authenticated and not user_is_moderator and not debate_in_progress and post.debate_category == "closed"  %}
        <a href={% url 'debate:join_participants' post_id=post.id position="supporting"  %}>
          Apply to join supporting team.
        </a>
        {% endif %}
        </div>

        <div class="col m6">
        {% if post.opposing_debaters.all %}
          <h6>Opposing </h6><span><i class="material-icons">group</i></span>
          <ul class="collection">
            {% for names in post.opposing_debaters.all %}
            <li class="collection-item avatar">
              {% if names|has_avatar %}
                {% avatar names 35 class="circle responsive-img" %}
              {% elif names.socialaccount_set.all.0.get_avatar_url %}
                <img  src="{{ names.socialaccount_set.all.0.get_avatar_url }}" class="circle responsive-img" width="35" height="35" />
              {% else %}
                <img src="{{names.profile.profile_image_url}}" class="circle responsive-img" width="35" height="35" />
              {% endif %}
              <span class="title">{{ names.get_full_name }}</span>
              <p><a href={{names.profile.get_absolute_url}}>@{{names.username}}</a> <br>
                 Speaker {{forloop.counter}}
              </p>

            </li>
            {% endfor %}
            </ul>
          {%endif%}

        {% if user.is_authenticated and not user_is_moderator and not debate_in_progress and post.debate_category == "closed"%}
        <a href={% url 'debate:join_participants' post_id=post.id position="opposing"  %}>
          Apply to join opposing team.
        </a>
        {% endif %}
        </div>
      {% endif %}

          {% if user_is_moderator and not debate_in_progress %}
            Share post amidst your friends and colleagues to gain the audience it deserves.
          {% endif %}
      </div><!-- End of row div -->
    </div><!-- End of debaters div -->

        <div id="panel">
          <div class="row">
            <div class="col m6">
            {% if post.moderator.all %}
              <h6>Moderator(s) </h6><span><i class="material-icons">group</i></span>
              <ul class="collection">
                {% for names in post.moderator.all %}
                <li class="collection-item avatar">
                  {% if names|has_avatar %}
                    {% avatar names 35 class="circle responsive-img" %}
                  {% elif names.socialaccount_set.all.0.get_avatar_url %}
                    <img  src="{{ names.socialaccount_set.all.0.get_avatar_url }}" class="circle responsive-img" width="35" height="35" />
                  {% else %}
                    <img src="{{names.profile.profile_image_url}}" class="circle responsive-img" width="35" height="35" />
                  {% endif %}
                  <span class="title">{{ names.get_full_name }}</span>
                  <p><a href={{names.profile.get_absolute_url}}>@{{names.username}}</a> <br>
                     Mod {{forloop.counter}}
                  </p>

                </li>
                {% endfor %}
              </ul>
            {%endif%}
          </div>
          <div class="col m6">
              {% if post.judges.all %}
                <h6>Judge(s) </h6><span><i class="material-icons">group</i></span>
                <ul class="collection">
                  {% for names in post.judges.all %}
                  <li class="collection-item avatar">
                    {% if names|has_avatar %}
                      {% avatar names 35 class="circle responsive-img" %}
                    {% elif names.socialaccount_set.all.0.get_avatar_url %}
                      <img  src="{{ names.socialaccount_set.all.0.get_avatar_url }}" class="circle responsive-img" width="35" height="35" />
                    {% else %}
                      <img src="{{names.profile.profile_image_url}}" class="circle responsive-img" width="35" height="35" />
                    {% endif %}
                    <span class="title">{{ names.get_full_name }}</span>
                    <p><a href={{names.profile.get_absolute_url}}>@{{names.username}}</a> <br>
                       Judge {{forloop.counter}}
                    </p>

                  </li>
                  {% endfor %}
                </ul>
              {%endif%}

            </div>

          </div><!-- End of row div -->


        </div>
      </div>

    </div> <!-- End of card -->
{% endif %}
      <p>Confused? Read our <a href="{% url 'faq' %}">FAQs</a> and <a href="{% url 'debate:rules_guidelines' %}">Rules</a> to understand how things work here.</p>

  {% get_comment_form for post as form %}
  {% if open_comment %}
    <div class="card">
      <div class="row">
        {% include "comments/form.html" %}
      </div>
    </div>
  {% endif %}

      {% if comment_count %}
            {% render_xtdcomment_tree for post allow_flagging allow_feedback show_feedback  %}
    {% endif %}

{% if not post %}
  <p>There are currently no debates posted. You can add a debate or check back</p>
{% endif %}

</div><!-- End of col -->

  <div class="col m3 l3">
    <p>
      <a class="yellow btn black-text" href="{% url 'debate:suggest_post' %}">New debate</a>
    </p>
    {% if similar_posts %}
    <p class="small_text">Related Debate{{similar_postso.count|pluralize}}.</p>
    <ul>
      {% for lists in similar_posts %}
      <li><a class="small_text" href="{{lists.get_absolute_url}}">{{lists|capfirst}}</a></li>
      {% endfor %}
      <li class="divider"></li>
    </ul>
    {% endif %}

    {% if post.winner_updated or debate_has_ended %}
    <div class="card-panel">
      <p class="text-danger small_text">Results:<br>
      Supporting: {{total_support_vote}} vote{{total_support_vote|pluralize }}<br>
      Opposing: {{total_oppose_vote}} vote{{total_oppose_vote|pluralize }}
      <br>
      Winner: {{post.winner|capfirst}}
      <br>
      See full <a href="{% url 'debate:score_debate' post.pk %}">result details.</a>

      </p>
    </div>
    {% endif %}

    <div class="card-panel">
        <div class="row">
        {% if voted_before or not voting_has_started %}
        <div class="col s12 m6">
          <a name="{{ post.slug }}" value="support" class="waves-effect waves-light vote btn-floating disabled">
            <i class="material-icons">thumbs_up_down</i></a>
            Support
        </div>
        <div class="col s12 m6">
          <a name="{{ post.slug }}" value="oppose" class="waves-effect waves-light vote btn-floating disabled">
            <i class="material-icons">thumbs_up_down</i></a>
            Oppose
        </div>
        {% else %}
        <div class="col s12 m6">
          <a name="{{ post.slug }}" value="support" class="waves-effect waves-light vote btn-floating">
            <i class="blue material-icons">thumbs_up_down</i></a>
            Support
        </div>
        <div class="col s12 m6">
          <a name="{{ post.slug }}" value="oppose" class="waves-effect waves-light vote btn-floating">
            <i class="blue material-icons">thumbs_up_down</i></a>
            Oppose
        </div>

        {% endif %}
      </div>


        <p class="debate_stand small_text"><br>
        {% if vote_message %}{{vote_message}}
        {% else %}You have not voted in this debate{% endif %}
        <br>
          {% if not user.is_authenticated %}
          <a href="{% url 'account_login' %}">Login</a> or <a href="{% url 'account_signup' %}">SignUp</a> to vote.
          {% endif %}
        </p><hr/>
        <p class="small_text">Voting Starts :
            <span class="right">{% if post.vote_starts %}{{post.vote_starts}}{% else %}Not yet set by Mod{%endif%}</span><br>
          Voting Ends :
            <span class="right">{% if post.end %}{{post.end}}{% else %}Not yet set by Mod{%endif%}</span><br>
          Result displayed afterwards. Please be patient.</p>
      </div>

    {% if post.count %}
          <div class="card-panel small_text">
        Total Followers : <br>{{post.count}} person{{ post.count|pluralize }}.
          </div>
    {% endif %}

      <div class="card-panel">
          <i class="small material-icons">access_alarm</i>
          {% if notify_status or not user.is_authenticated %}
            <button  name="{{ post.slug }}" value="notify" class="small yellow btn black-text disabled notify">Notify Me</button>
          {% else %}
            <button  name="{{ post.slug }}" value="notify" class="small yellow btn black-text btn notify">Notify Me</button>
          {% endif %}
          <hr>
          {% if notify_status %}
            <p class="has_set_notification small_text">You have previously set notification for this debate. You would be notified via email 15 mins before debate starts.</p><br>
          {% else %}
            <p class="has_set_notification small_text">Enable alert for debate and get notified before debate starts. {%if not user.is_authenticated %}You must be <a href="{% url 'account_login' %}">logged in</a>.{%endif%}</p><br>
          {% endif %}
      </div>

 </div>

 </div>

{% endblock %}

{% block extra-js %}
<script>

$(document).ready(function(){
    $("select#debate_option").change(function(){
        var text_content =$("textarea#id_comment").val();
        var debate_option = $("#debate_option option:selected").val();
        $("textarea#id_comment").val("`"+debate_option + "`\n" + text_content);
    });
});

$('.like-button').click(function(){
      $.ajax({
               type: "POST",
               url: "{% url 'debate:like' %}",
               data: {'slug': $(this).attr('name'), 'csrfmiddlewaretoken': '{{ csrf_token }}'},
               dataType: "json",
               success: function(response) {
                      // alert(response.message);
                      // alert('Debate likes count is now ' + response.likes_count);
                      $(".total_likes").text(response.likes_count);
                      if (response.liked){
                        if($(".like-button").hasClass("grey-text")){
                             $(".like-button").removeClass("grey-text").addClass("blue-text");
                           };
                      }else{
                        $(".like-button").removeClass("blue-text").addClass("grey-text");
                      };
                },
                error: function(rs, e) {
                       console.log(rs.responseText);
                }
          });
});

$('.vote').click(function(){
      $.ajax({
               type: "POST",
               url: "{% url 'debate:vote' %}",
               data: {'slug': $(this).attr('name'), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'debate_stand':$(this).attr('value')},
               dataType: "json",
               success: function(response) {
                      //alert(response.message);
                      $(".debate_stand").text(response.message);
                      $(".vote").addClass("disabled");

                },
                error: function(rs, e) {
                       //alert(rs.responseText);
                }
          });
});

$('.notify').click(function(){
      $.ajax({
               type: "POST",
               url: "{% url 'debate:notify' %}",
               data: {'slug': $(this).attr('name'), 'csrfmiddlewaretoken': '{{ csrf_token }}', },
               dataType: "json",
               success: function(response) {
                      //alert(response.message);
                      $(".has_set_notification").text(response.message);
                      $(".notify").addClass("disabled");

                },
                error: function(rs, e) {
                       //alert(rs.responseText);
                }
          });
});

$('.like-comment').click(function(ev){
      comment_id = $(this).attr('id')
      liked_id = "liked_"+comment_id
      liked_value = $("#"+liked_id).text()
      //console.log(liked_value)

      $.ajax({

               type: "POST",
               url: "/comments/like/"+comment_id+"/",
               data: {'comment_id': $(this).attr('id'), 'csrfmiddlewaretoken': '{{ csrf_token }}'},
               dataType: "json",
               success: function(response) {
                 //I could only update it using the error function
                      //liked_value = liked_value + 1
                      //$("#"+liked_id).text(response.total_comment_like);
                },
                error: function(rs, e) {
                    //console.log(rs.responseText);
                      if($('.like-comment').hasClass("liked")){
                          liked_value = Number(liked_value) - 1
                          if (liked_value == -1){ liked_value = 0};
                           $('.like-comment').removeClass("liked");
                           $('.mtl').removeClass("blue-text").addClass("grey-text");

                      }else{
                          liked_value = Number(liked_value) + 1

                          $('.like-comment').addClass("liked");
                          $('.mtl').removeClass("grey-text").addClass("blue-text");
                        };
                    $("#"+liked_id).text(liked_value);
                    }
          });
});

$('.dislike-comment').click(function(ev){
      comment_id = $(this).attr('id')
      disliked_id = "disliked_"+comment_id
      liked_value = $("#"+disliked_id).text()
      //console.log(liked_value)

      $.ajax({

               type: "POST",
               url: "/comments/dislike/"+comment_id+"/",
               data: {'comment_id': $(this).attr('id'), 'csrfmiddlewaretoken': '{{ csrf_token }}'},
               dataType: "json",
               success: function(response) {
                 //I could only update it using the error function
                      //liked_value = liked_value + 1
                      //$("#"+liked_id).text(response.total_comment_like);
                },
                error: function(rs, e) {
                    //console.log(rs.responseText);
                      if($('.dislike-comment').hasClass("disliked")){
                          liked_value = Number(liked_value) - 1
                          if (liked_value == -1){ liked_value = 0};
                           $('.dislike-comment').removeClass("disliked");
                           $('.mtdl').removeClass("red-text").addClass("grey-text");

                      }else{
                          liked_value = Number(liked_value) + 1
                          $('.dislike-comment').addClass("disliked");
                          $('.mtdl').removeClass("grey-text").addClass("red-text");
                        };
                    $("#"+disliked_id).text(liked_value);
                    }
          });
});



</script>
{% endblock %}
