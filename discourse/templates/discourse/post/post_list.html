{% extends "discourse/base.html" %}
{% load widget_tweaks %}
{% load humanize %}
{% load markdownify %}
{% load md2 %}
{% load comments %}
{% load comments_xtd %}
{% load i18n %}

{% block title %}Discourse{% endblock %}

{% block content %}

<div class="row">
  <div class="col m2">
    {% if tag %}
    <div class="row">
      <br><br> Results for:
      <a href="{% url 'discourse:post_list_by_tag' tag.slug  %}"><span class="new badge grey" data-badge-caption="">{{ tag.name }}</span></a>
    </div>
    {% endif %}
  </div>
  <div class="col m7">
    {% if object_list %}
      {% for post in object_list.object_list %}

    <div class="card">
      <div class="card-content">
        {% for tag in post.tags.all %}
          <a href="{% url 'discourse:post_list_by_tag' tag.slug  %}"><span class="new badge grey" data-badge-caption="">{{ tag.name }}</span></a>
        {% endfor %}
        <h5 class=""><a href="{{post.get_absolute_url}}">{{post.title}}</a></h5>
        <p>{{post.summary|truncatechars:300|markdown:"safe, code-friendly, code-color"|linebreaks}}</p>
        <p>Created {{post.created|naturaltime}}
          ,by <a href="{{post.author.profile.get_absolute_url}}">{{post.author.get_full_name}}</a>

          {% get_comment_count for post as comment_count %}
          <span class="right">
            {{ comment_count }}
            <i class="material-icons">comment</i>
            {{ post.total_likes }}
            <i class="material-icons">thumb_up</i>
          </span>

        </p>

        </div>


      </div><!-- End of card -->

    {% endfor %}

        <div>
            {{ object_list.render }}
        </div>

    {% else %}
      <p>There are no posts yet. Check back.</p>
    {% endif %}

    {% if user.is_authenticated %}
          <div class="card">
            <div class="card-content">
              <p>Create a new discourse.</p>
              <form method="post" action="{% url 'discourse:new_post' %}">
                {% csrf_token %}
                {% for field in form %}

                <div class="row">
                  <div class="input-field col l12">
                    {% if field.name == "summary" %}
                    {{ field|attr:"class:materialize-textarea"}}
                    {% elif field.name == "attachment" %}
                    <div class="file-field input-field">
                      <div class="btn">
                        <span>File</span>
                        <input accept="image/*" id="id_attachment" multiple="multiple" name="attachment" type="file">
                      </div>
                      <div class="file-path-wrapper">
                        <input class="file-path validate" type="text">
                      </div>
                    </div>

                    {% else %}
                    <div class="input-field">
                      {{ field}}
                    </div>
                    {% endif %}
                    <!-- <label for="field.name">{{field.label_tag}}</label> -->
                    <p>
                      {% if field.help_text %}
                          <small class="grey-text">{{ field.help_text|markdownify }}</small>
                      {% endif %}
                      {% for errror in field.errors %}
                      <strong class="red-text">{{ error|escape }}</strong>
                      {% endfor %}
                    </p>
                  </div>

                </div>

              {% endfor %}
                <button class="btn" type="submit">Post Debate &raquo;</button>
              </form>

        </div>
      </div><!-- End of Card -->
      {% endif %}

</div>

  <div class="col m3">
    {% get_last_xtdcomments 5 as last_comments for discourse.post %}
    {% if last_comments %}
    <h6>Latest Comments</h6>
        {% for comment in last_comments %}
        {% if not comment.is_removed %}
        <div class="card">
          <div class="card-content">

          <div id="c{{ comment.id }}" class="media">
          <a name="c{{ comment.id }}"></a>
          <!-- <div class="media-left"><img src="{{ comment.user.profile.image.thumbnail.25x25 }}"/></div> -->
          <div class="media-body">
            <div class="comment">
              <h6 class="media-heading">
                {% trans "Posted to "%}&nbsp;<a href="{{ comment.content_object.get_absolute_url }}">{{ comment.content_object }}</a>&nbsp;-&nbsp;
                {{ comment.submit_date|timesince }}&nbsp;-&nbsp;{% if comment.url and not comment.is_removed %}<a href="{{ comment.url }}" target="_new">{% endif %}{{ comment.name }}{% if comment.url %}</a>{% endif %}&nbsp;&nbsp;<a class="permalink" title="comment permalink" href="{% get_comment_permalink comment %}"><i class="fa fa-share" aria-hidden="true"></i></a>
              </h6>
                {{ comment.comment|truncatechars:150|markdown:"safe, code-friendly, code-color"|linebreaks}}

            </div>
          </div>
          </div>

        </div>
      </div><!-- End of card -->
      {% endif %}
        {% endfor %}

    {% endif %}

 </div>
</div>

{% endblock %}
