{% extends "discourse/base.html" %}
{% load humanize %}
{% load md2 %}
{% load markdownify %}
{% load comments %}
{% load comments_xtd %}
{% load widget_tweaks %}
{% load avatar_tags %}

{% load staticfiles %}

{% block title %}{{post.title}}{% endblock %}

{% block extra_nav %}
  {% if post.author == user %}
  <p>
    <a href="{% url 'discourse:edit_post' post.id %}">
        Edit this post</a>
  </p>
  {% endif %}
{% endblock extra_nav %}



<!-- Main Post details -->
{% block content %}

<div class="row">


  <div class="col m7 offset-m2">
    {% if post %}

    <div class="card">
        <div class="card-content">
          {% for tag in post.tags.all %}
            <a href="{% url 'discourse:post_list_by_tag' tag.slug  %}"><span class="new badge amber lighten-4 black-text" data-badge-caption="">{{ tag.name }}</span></a>
          {% endfor %}
          {% if post.updated != post.created %}<small class="grey-text">Last Edited {{post.updated|naturaltime}}</small>{% endif %}
          <h5 class="">{{post.title}}</h5>
          <p class="justify">{{post.summary|markdown:"safe, code-friendly, code-color"|linebreaks}}</p>
          {% if post.author == user %}
          <p>
            <a href="{% url 'discourse:edit_post' post.id %}">
                Edit this post</a>
          </p>
          {% endif %}

          {% get_comment_count for post as comment_count %}
          <span class="right">
            <i class="material-icons">comment</i> {{ comment_count }}
          </span>

          <span class="right">
              {% if user.is_authenticated %}

                  <span class="total_likes right">{{ post.total_likes }}</span>
                  <a class="btn-floating waves-effect white"><i class="material-icons like-button
                    {% if liked %} blue-text {% else %} grey-text {% endif %} " name="{{ post.slug }}" value="Like">thumb_up</i></a>

            {% else %}
            <a class="btn-floating tooltipped" data-position="top" data-delay="50" data-tooltip="Login or Signup to like.">
              <i class="material-icons">thumb_up</i></a>
            <span>{{post.total_likes}}</span>
            {% endif %}
          </span>

          {% include "share_button.html" %}

            <p class="grey-text">
            Posted {{post.created|naturaltime}},
            By {{post.author.get_full_name}}</p>
        </div>

      </div><!-- End of card -->


      {% get_comment_form for post as form %}
      {% if user.is_authenticated %}
    <div class="card">
      <div class="row">
        <form class="col s12" method="POST" action="{% comment_form_target %}">
          {% csrf_token %}
              <input type="hidden" name="next" value="{% url 'comments-xtd-sent' %}"/>
              <div class="red hidden" data-comment-element="errors"></div>
              {% for field in form %}
                {% if field.is_hidden %}<div>{{ field }}</div>{% endif %}
              {% endfor %}
              <div style="display:none">{{ form.honeypot }}</div>

          <div class="row">
            <div class="input-field col s12 {% if 'comment' in form.errors %}has-error{% endif %}">
              {% include "button_click.html" %}
              {% render_field form.comment class="materialize-textarea" data-length="3000" %}
              <label for="id_comment">Comment on post. Be concise and cogent.</label>
            </div>
          </div>

          <div>
              <input type="submit" name="post" value='send' class="blue btn" />
              <input type="submit" name="preview" value="preview" class="btn grey" />
          </div>

          <div class="row">
          <small>
            <a href='http://commonmark.org/help/' target='_blank'>Mardown </a>and <a target='_blank' href="https://math.meta.stackexchange.com/questions/5020/mathjax-basic-tutorial-and-quick-reference">MathJax</a> supported.
            <br>For open debate, indicate if supporting or opposing at top of comment.
          </small>
        </div>

        </form>
      </div>
    </div>
      {% endif %}

    {% if comment_count %}
            {% render_xtdcomment_tree for post allow_flagging allow_feedback show_feedback  %}
    {% endif %}

    {% endif %}

  </div><!-- End of colm7 -->

  <div class="col s12 m3">
    <div class="row">
      <br>
        <a href="{% url 'discourse:new_post' %}">
      <button class="yellow btn black-text">Create New Discourse</button></a>
    </div>


    {% if post.count %}
          <div class="card-panel">
        Total Followers : <br>{{post.count}} person{{ post.count|pluralize }}.
          </div>

    {% endif %}


 </div>
</div><!-- End of main row -->

{% endblock %}

{% block extra-js %}
<script>
$('.like-button').click(function(){
      $.ajax({
               type: "POST",
               url: "{% url 'discourse:like-post' %}",
               data: {'slug': $(this).attr('name'), 'csrfmiddlewaretoken': '{{ csrf_token }}'},
               dataType: "json",
               success: function(response) {
                      // alert(response.message);
                      // alert('Post likes count is now ' + response.likes_count);
                      $(".total_likes").text(response.likes_count);
                      if (response.liked){
                        if($(".like-button").hasClass("grey-text")){
                             $(".like-button").removeClass("grey-text").addClass("blue-text");
                           };
                      }else{
                        $(".like-button").removeClass("blue-text").addClass("grey-text");
                      };
                },
                error: function(rs, e) {
                       //alert(rs.responseText);
                }

          });

});


{% for image in attachments %}

$(document).ready(function(){
  var id = {{forloop.counter}}
  var img_css_id = "image"+id.toString()
  //console.log(img_css_id)
  $.ajax({
           type: "POST",
           url: "{% url 'discourse:load_post_image' %}",
           data: {'csrfmiddlewaretoken': '{{ csrf_token }}', 'post_id':$("#"+img_css_id).attr('post_id'),'image_id':$("#"+img_css_id).attr('image_id'), },
           success: function(response) {
                  $('#'+img_css_id).html('<img class="responsive-img", src="data:image/png;base64,' + response + '" />');

            },
            error: function(rs, e) {
                   //alert(rs.responseText);
            }
      });
});

{% endfor %}


</script>

{% endblock %}
