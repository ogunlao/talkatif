{% extends "discourse/base.html" %}
{% load humanize %}
{% load md2 %}
{% load comments %}
{% load comments_xtd %}
{% load widget_tweaks %}

{% load staticfiles %}

{% block title %}Discourse Topic{% endblock %}

{% block extra_nav %}
  {% if post.author == user %}
  <p>
    <a href="{% url 'discourse:edit_post' post.id %}">
        Edit this post</a>
  </p>
  {% endif %}
{% endblock extra_nav %}



<!-- Main Post details -->
{% block content %}

<div class="row">
  <div class="col m2"></div>

  <div class="col m7">
    {% if post %}

    <div class="card">
        <div class="card-content">
          {% for tag in post.tags.all %}
            <a href="{% url 'discourse:post_list_by_tag' tag.slug  %}"><span class="new badge grey" data-badge-caption="">{{ tag.name }}</span></a>
          {% endfor %}
          {% if post.updated != post.created %}<p class="small">Edited</p>{% endif %}
          <h5 class="">{{post.title}}</h5>
          <p class="justify">{{post.summary|markdown:"safe, code-friendly, code-color"|linebreaks}}</p>
          {% if post.author == user %}
          <p>
            <a href="{% url 'discourse:edit_post' post.id %}">
                Edit this post</a>
          </p>
          {% endif %}

          {% get_comment_count for post as comment_count %}
          <span class="right">
            <i class="material-icons">comment</i> {{ comment_count }}
          </span>

          <span class="right">
              {% if user.is_authenticated %}
                {% if liked %}
                  <a class="btn-floating white"><i class="material-icons like-button red-text" name="{{ post.slug }}" value="Like">thumb_up</i></a>
                {% else %}
                  <a class="btn-floating white"><i class="tiny material-icons like-button grey-text" name="{{ post.slug }}" value="Like">thumb_up</i></a>
                {% endif %}

              <span class="total_likes right">{{ post.total_likes }}</span>

            {% else %}
            <a class="btn-floating tooltipped" data-position="top" data-delay="50" data-tooltip="Login or Signup to like.">
              <i class="tiny material-icons">thumb_up</i></a>
            <span>{{post.total_likes}}</span>
            {% endif %}
          </span>

          <div class="fixed-action-btn horizontal">
            <a class="btn-floating btn-large red pulse">
              <i class="large material-icons">share</i>
            </a>
            <ul>
              <li><a href="http://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}"
                 class="waves-effect waves-light btn-floating social facebook">
                      <i class="fa fa-facebook"></i></a></li>
              <li><a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri|urlencode }}"
                class="waves-effect waves-light btn-floating social twitter">
                      <i class="fa fa-twitter"></i></a></li>
              <li><a href="http://www.linkedin.com/shareArticle?url={{ request.build_absolute_uri|urlencode }}&title={{post.title}}&summary={{post.summary}}&source={{ request.get_host }}"
                class="waves-effect waves-light btn-floating social linkedin">
                      <i class="fa fa-linkedin"></i></a></li>
              {% if request.user_agent.is_mobile or request.user_agent.is_tablet %}
              <li><a href="whatsapp://send?text='{{request.get_host}}{{ post.get_absolute_url }}  \n {{post.title}}'" data-action="share/whatsapp/share" class="waves-effect waves-light btn-floating social whatsapp">
                      <i class="fa fa-whatsapp"></i></a></li>
              {% endif %}
            </ul>
          </div>

            <p class="grey-text">
            Posted {{post.created|naturaltime}},
            By {{post.author.get_full_name}}</p>
        </div>


        {%if attachments%}
        <div class="row">
          <div class="card-image">
        {%for image in attachments%}
          {% if attachments.count == 1 %}
              <div class="row">
                <div class="col m3"></div>
                <div class="col m6">
                  <span id="image{{forloop.counter}}" post_id ={{post.id}} image_id = {{image.id}} >
                    <i class="fa fa-spinner fa-spin fa-3x fa-fw"></i>
                      <span class="sr-only">Loading...</span>
                  </span>
                </div>
              </div>

          {% else %}

            <div class="col l6 ">
            <span id="image{{forloop.counter}}" post_id ={{post.id}} image_id = {{image.id}} >
              <i class="fa fa-spinner fa-spin fa-3x fa-fw"></i>
                <span class="sr-only">Loading...</span>
            </span>
            </div>


          {% endif %}
          {% endfor %}
          </div>
          </div>
        {% endif %}


      </div><!-- End of card -->


      {% get_comment_form for post as form %}
      {% if user.is_authenticated %}
    <div class="card">
      <div class="row">
        <form class="col s12" method="POST" action="{% comment_form_target %}">
          {% csrf_token %}
              <input type="hidden" name="next" value="{% url 'comments-xtd-sent' %}"/>
              <div class="red hidden" data-comment-element="errors"></div>
              {% for field in form %}
                {% if field.is_hidden %}<div>{{ field }}</div>{% endif %}
              {% endfor %}
              <div style="display:none">{{ form.honeypot }}</div>

          <div class="row">
            <div class="input-field col s12 {% if 'comment' in form.errors %}has-error{% endif %}">
              {% render_field form.comment class="materialize-textarea" data-length="3000" %}
              <label for="id_comment">Comment on post. Be concise and cogent.</label>
            </div>
          </div>

          <div>
              <input type="submit" name="post" value='send' class="btn" />
              <input type="submit" name="preview" value="preview" class="btn grey" />
          </div>

          <div class="row">
          <small>
            <a href='http://commonmark.org/help/' target='_blank'>Mardown </a>and <a target='_blank' href="https://math.meta.stackexchange.com/questions/5020/mathjax-basic-tutorial-and-quick-reference">MathJax</a> supported.
            <br>For open debate, indicate if supporting or opposing at top of comment.
          </small>
        </div>

        </form>
      </div>
    </div>
      {% endif %}

    {% if comment_count %}
            {% render_xtdcomment_tree for post allow_flagging allow_feedback show_feedback  %}
    {% endif %}

    {% endif %}
  </div><!-- End of colm7 -->

  <div class="col s12 m3">
    <div class="row">
      <br>
        <a href="{% url 'discourse:new_post' %}">
      <button class="btn">Create New Discourse</button></a>
    </div>


    {% if post.count %}
    <div class="card">
      <div class="card-content">

        <p>Page Views : <br>{{post.count}}</p>

      </div>
    </div>
      {% endif %}


 </div>
</div><!-- End of main row -->

{% endblock %}

{% block extra-js %}
<script>
$('.like-button').click(function(){
      $.ajax({
               type: "POST",
               url: "{% url 'discourse:like-post' %}",
               data: {'slug': $(this).attr('name'), 'csrfmiddlewaretoken': '{{ csrf_token }}'},
               dataType: "json",
               success: function(response) {
                      // alert(response.message);
                      // alert('Post likes count is now ' + response.likes_count);
                      $(".total_likes").text(response.likes_count);
                      if (response.liked){
                        if($(".like-button").hasClass("grey-text")){
                             $(".like-button").removeClass("grey-text").addClass("red-text");
                           };
                      }else{
                        $(".like-button").removeClass("red-text").addClass("grey-text");
                      };
                },
                error: function(rs, e) {
                       //alert(rs.responseText);
                }

          });

});


{% for image in attachments %}

$(document).ready(function(){
  var id = {{forloop.counter}}
  var img_css_id = "image"+id.toString()
  //console.log(img_css_id)
  $.ajax({
           type: "POST",
           url: "{% url 'discourse:load_post_image' %}",
           data: {'csrfmiddlewaretoken': '{{ csrf_token }}', 'post_id':$("#"+img_css_id).attr('post_id'),'image_id':$("#"+img_css_id).attr('image_id'), },
           success: function(response) {
                  $('#'+img_css_id).html('<img class="responsive-img", src="data:image/png;base64,' + response + '" />');

            },
            error: function(rs, e) {
                   //alert(rs.responseText);
            }
      });
});

{% endfor %}


</script>

{% endblock %}
